<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äì Event Registrations</title>

  <style>
    body { margin:0; font-family:Inter,Arial; background:#eef2ff; color:#222; }
    .navbar { background:#14213D; padding:16px 24px; color:#fff; display:flex; justify-content:space-between; align-items:center; font-weight:700; }
    .back-btn { color:#fff; text-decoration:none; background:rgba(255,255,255,0.12); padding:8px 12px; border-radius:8px; }
    .container { max-width:1000px; margin:32px auto; padding:0 16px; }
    .event-card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 6px 20px rgba(0,0,0,0.08); margin-bottom:18px; text-align:center; }
    #poster { width:100%; max-height:340px; object-fit:cover; border-radius:10px; display:none; margin-bottom:12px; }
    .event-title { font-size:26px; color:#14213D; font-weight:800; margin-bottom:6px; }
    .event-date { color:#555; margin-bottom:8px; }
    .stats-box { background:#14213D; color:#fff; padding:12px 16px; border-radius:10px; font-weight:700; text-align:center; margin-bottom:18px; }
    .table-wrap { overflow:auto; background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px 14px; border-bottom:1px solid #eee; text-align:left; font-size:15px; }
    th { background:#14213D; color:#fff; position:sticky; top:0; }
    tr:nth-child(even){ background:#fbfdff; }
    tr:hover { background:#e9f0ff; }
    #noData, #errorMsg { text-align:center; color:#444; margin-top:18px; }
    .loading { text-align:center; padding:18px; color:#666; }
  </style>
</head>

<body>

<script>
  if (!sessionStorage.getItem("userQID") || sessionStorage.getItem("userType") !== "admin") {
    window.location.href = "login.html";
  }
</script>

<div class="navbar">
  <div>Event Registrations</div>
  <a class="back-btn" href="events_list_admin.html">‚¨Ö Back</a>
</div>

<div class="container">
  <div id="loading" class="loading">Loading event & registrations‚Ä¶</div>

  <div id="eventArea" style="display:none;">
    <div class="event-card">
      <img id="poster" alt="Event poster">
      <div class="event-title" id="eventTitle">‚Äî</div>
      <div class="event-date" id="eventDate">‚Äî</div>
      <div class="small" id="eventVenue"></div>
    </div>

    <div id="statsBox" class="stats-box">‚Äî</div>

    <div class="table-wrap">
      <table id="table" style="display:none;">
        <thead>
          <tr>
            <th>Name</th>
            <th>QID</th>
            <th>Email</th>
            <th>Program</th>
            <th>Branch</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <p id="noData"></p>
      <p id="errorMsg"></p>
    </div>
  </div>
</div>

<script type="module">
  import { db } from "./js/firebase.js";
  import {
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const loading = document.getElementById("loading");
  const eventArea = document.getElementById("eventArea");
  const table = document.getElementById("table");
  const tableBody = document.getElementById("tableBody");
  const noData = document.getElementById("noData");
  const errorMsg = document.getElementById("errorMsg");

  function showError(message) {
    errorMsg.innerText = message;
    loading.style.display = "none";
  }

  async function loadPage() {
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("id");

    if (!eventId) return showError("Missing event ID in URL.");

    loading.style.display = "block";

    // 1Ô∏è‚É£ Load event details from eventDetails
    const eventRef = doc(db, "eventDetails", eventId);
    const eventSnap = await getDoc(eventRef);

    if (!eventSnap.exists()) {
      return showError("Event not found in eventDetails collection.");
    }

    const event = eventSnap.data();

    // Set UI
    document.getElementById("eventTitle").innerText = event.title;
    document.getElementById("eventDate").innerText =
      "üìÖ " + new Date(event.date).toDateString();

    if (event.venue) {
      document.getElementById("eventVenue").innerText = "üìç " + event.venue;
    }

    if (event.poster) {
      const posterEl = document.getElementById("poster");
      posterEl.src = event.poster;
      posterEl.style.display = "block";
    }

    // 2Ô∏è‚É£ Load registrations from eventRegistrations
    const regQuery = query(
      collection(db, "eventRegistrations"),
      where("eventId", "==", eventId)
    );

    const regSnap = await getDocs(regQuery);
    loading.style.display = "none";
    eventArea.style.display = "block";

    const count = regSnap.size;
    document.getElementById("statsBox").innerText = `${count} Students Registered`;

    if (regSnap.empty) {
      noData.innerText = "No registrations yet.";
      return;
    }

    table.style.display = "table";

    // 3Ô∏è‚É£ Populate table
    for (const regDoc of regSnap.docs) {
      const qid = regDoc.data().qid;

      const studentSnap = await getDocs(
        query(collection(db, "students"), where("qid", "==", qid))
      );

      if (!studentSnap.empty) {
        const s = studentSnap.docs[0].data();
        tableBody.innerHTML += `
          <tr>
            <td>${s.name}</td>
            <td>${s.qid}</td>
            <td>${s.email}</td>
            <td>${s.program}</td>
            <td>${s.branch}</td>
          </tr>
        `;
      }
    }
  }

  loadPage();
</script>

</body>
</html>
