<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: Inter, Arial;
      background: #eef2ff;
    }

    /* NAVBAR */
    .navbar {
      background: #14213D;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      font-size: 20px;
      font-weight: 700;
    }
    .logout-btn {
      background: #e63946;
      border: none;
      color: white;
      padding: 10px 18px;
      font-size: 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .logout-btn:hover { background: #b02028; }

    /* BANNER */
    .banner {
      margin: 30px auto 5px;
      text-align: center;
      max-width: 800px;
    }
    .banner h2 {
      font-size: 32px;
      color: #14213D;
      margin-bottom: 8px;
      font-weight: 800;
    }
    .events-btn {
      display: inline-block;
      background: #14213D;
      padding: 12px 24px;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 700;
      font-size: 16px;
      margin-top: -5px;
    }

    /* INFO GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 18px;
      max-width: 900px;
      margin: 25px auto;
      padding: 0 20px;
    }
    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 4px 13px rgba(0,0,0,0.15);
      text-align: center;
    }
    .card h3 {
      margin-bottom: 8px;
      color: #14213D;
      font-size: 20px;
      font-weight: 700;
    }
    .card p {
      margin: 6px 0;
      font-size: 17px;
      font-weight: 600;
      color: #222;
    }
    #passMsg {
      font-size: 15px;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<!-- SESSION PROTECTION -->
<script>
  if (!sessionStorage.getItem("userQID") || sessionStorage.getItem("userType") !== "student") {
    window.location.href = "login.html";
  }
</script>

<!-- NAVBAR -->
<div class="navbar">
  Student Dashboard
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- BANNER -->
<div class="banner">
  <h2 id="studentName">Welcome ðŸ‘‹</h2>
  <a href="events.html" class="events-btn">View Events</a>
</div>

<!-- INFO GRID -->
<div class="grid">
  <div class="card">
    <h3>QID</h3><p id="s_qid">Loading...</p>
  </div>
  <div class="card">
    <h3>Email</h3><p id="s_email">Loading...</p>
  </div>
  <div class="card">
    <h3>Program</h3><p id="s_program">Loading...</p>
  </div>
  <div class="card">
    <h3>Branch</h3><p id="s_branch">Loading...</p>
  </div>
</div>

<!-- CHANGE PASSWORD -->
<div class="card" style="max-width:500px; margin: 40px auto;">
  <h3>Change Password</h3>
  <input type="password" id="currentPass" placeholder="Current Password" style="width:100%; padding:10px; margin-bottom:10px;">
  <input type="password" id="newPass" placeholder="New Password" style="width:100%; padding:10px; margin-bottom:10px;">
  <input type="password" id="confirmPass" placeholder="Confirm New Password" style="width:100%; padding:10px; margin-bottom:10px;">
  <button class="logout-btn" style="background:#0077b6; width:100%; border-radius:6px;" id="updatePassBtn">Update Password</button>
  <p id="passMsg"></p>
</div>

<!-- REGISTERED EVENTS SECTION -->
<div class="card" style="max-width:500px; margin: 40px auto;">
  <h3>Registered Events</h3>
  <ul id="registeredEvents" style="list-style:none; padding:0;"></ul>
  <p id="noEvents" style="text-align:center;"></p>
</div>

<!-- FIREBASE -->
<script type="module" src="./js/firebase.js"></script>

<!-- LOAD STUDENT INFO -->
<script type="module">
  import { db } from "./js/firebase.js";
  import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const qid = sessionStorage.getItem("userQID");
  const q = query(collection(db, "students"), where("qid", "==", qid));
  const result = await getDocs(q);

  if (result.empty) {
    alert("Student record missing!");
    sessionStorage.clear();
    window.location.href = "login.html";
  }

  const data = result.docs[0].data();
  studentName.innerText = `Welcome, ${data.name} ðŸ‘‹`;
  s_qid.innerText = data.qid;
  s_email.innerText = data.email;
  s_program.innerText = data.program;
  s_branch.innerText = data.branch;
</script>

<!-- CHANGE PASSWORD -->
<script type="module">
  import { db } from "./js/firebase.js";
  import { collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  updatePassBtn.onclick = async () => {
    const current = currentPass.value;
    const newP = newPass.value;
    const confirm = confirmPass.value;

    if (!current || !newP || !confirm) {
      passMsg.innerText = "Please fill all fields";
      passMsg.style.color = "red";
      return;
    }
    if (newP !== confirm) {
      passMsg.innerText = "Passwords do not match";
      passMsg.style.color = "red";
      return;
    }

    const q = query(collection(db, "students"), where("qid", "==", sessionStorage.getItem("userQID")));
    const result = await getDocs(q);
    const docRef = result.docs[0].ref;
    const data = result.docs[0].data();

    if (data.password !== current) {
      passMsg.innerText = "Incorrect current password";
      passMsg.style.color = "red";
      return;
    }

    await updateDoc(docRef, { password: newP });
    passMsg.innerText = "Password updated successfully ðŸŽ‰";
    passMsg.style.color = "green";
    currentPass.value = newPass.value = confirmPass.value = "";
  };
</script>

<!-- REGISTERED EVENTS -->
<script type="module">
  import { db } from "./js/firebase.js";
  import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const qid = sessionStorage.getItem("userQID");
  const q = query(collection(db, "event_registrations"), where("qid", "==", qid));
  const regData = await getDocs(q);

  if (regData.empty) {
    noEvents.innerText = "No registrations yet";
  } else {
    regData.forEach(async (item) => {
      let eSnap = await getDoc(doc(db, "events", item.data().eventId));
      let event = eSnap.data();

      const li = document.createElement("li");
      li.style.margin = "8px 0";
      li.innerHTML = `
        <strong>${event.title}</strong> â€” ${event.date}<br>
        <a href="event_details.html?id=${item.data().eventId}" style="font-size:14px;">View Details</a>
      `;
      registeredEvents.appendChild(li);
    });
  }
</script>

<!-- LOGOUT -->
<script>
  function logout() {
    sessionStorage.clear();
    window.location.href = "index.html";
  }
</script>

</body>
</html>




